name: build_deps

on:
  push:
    branches:
      - main
    tags:
      - '20[2-9][0-9]-[0-9][0-9]-[0-9][0-9]'
  pull_request:
    paths-ignore:
      - '**.md'
    branches:
      - main

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  pre-checks:
    name: Run Pre-Checks
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    outputs:
      seekingTesters: ${{ steps.checks.outputs.seekingTesters }}
      shortHash: ${{ steps.checks.outputs.shortHash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for GitHub Labels
        id: checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          : Check for GitHub Labels

          case "${GITHUB_EVENT_NAME}" in
            pull_request)
              if gh pr view ${{ github.event.number }} --json labels \
                | jq -e -r '.labels[] | select(.name == "Seeking Testers")' > /dev/null; then
                echo "seekingTesters=true" >> $GITHUB_OUTPUT
              else
                echo "seekingTesters=false" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "seekingTesters=false" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "shortHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT
  ffmpeg-windows-build:
    name: Build FFmpeg for Windows
    runs-on: windows-2022
    needs: pre-checks
    strategy:
      fail-fast: true
      matrix:
        target: [x64]
        include:
          - target: x64
            config: Release
            type: static
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          # Setup Environment

          $Target='${{ matrix.target }}'
          $ArtifactName="ffmpeg-windows-${Target}-${{ needs.pre-checks.outputs.shortHash }}"
          $FileName="windows-ffmpeg-$(Get-Date -Format 'yyyy-MM-dd')-${Target}.zip"

          "artifactName=${ArtifactName}" >> $env:GITHUB_OUTPUT
          "artifactFileName=${FileName}" >> $env:GITHUB_OUTPUT

      - name: Build FFmpeg
        uses: ./.github/actions/build-ffmpeg
        with:
          target: ${{ matrix.target }}
          type: ${{ matrix.type }}
          config: ${{ matrix.config }}

      - name: Publish Build Artifacts
        if: github.event_name != 'pull_request' || fromJSON(needs.pre-checks.outputs.seekingTesters)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifactName }}
          path: ${{ github.workspace }}\windows\${{ steps.setup.outputs.artifactFileName }}
  windows-build:
    name: Build Windows Dependencies
    runs-on: windows-2022
    needs: pre-checks
    strategy:
      fail-fast: true
      matrix:
        config: [Release, Debug]
        include:
          - target: x64
            type: static
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          # Setup Environment

          $Target='${{ matrix.target }}'
          $Config='${{ matrix.config }}'
          $ArtifactName="deps-windows-${Target}-${Config}-${{ needs.pre-checks.outputs.shortHash }}"
          $FileName="windows-deps-$(Get-Date -Format 'yyyy-MM-dd')-${Target}-${Config}.zip"

          "artifactName=${ArtifactName}" >> $env:GITHUB_OUTPUT
          "artifactFileName=${FileName}" >> $env:GITHUB_OUTPUT

      - name: Build Windows Dependencies
        uses: ./.github/actions/build-deps
        with:
          target: ${{ matrix.target }}
          type: ${{ matrix.type }}
          config: ${{ matrix.config }}

      - name: Publish Build Artifacts
        if: github.event_name != 'pull_request' || fromJSON(needs.pre-checks.outputs.seekingTesters)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifactName }}
          path: ${{ github.workspace }}\windows\${{ steps.setup.outputs.artifactFileName }}

  linux-build:
    name: Build Linux Dependencies
    runs-on: ubuntu-22.04
    needs: pre-checks
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        config: [Release, Debug]
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            autoconf \
            automake \
            libtool \
            curl \
            git \
            nasm \
            yasm

      - name: Setup Environment
        id: setup
        run: |
          # Setup Environment

          TARGET="x86_64"
          CONFIG="${{ matrix.config }}"
          ARTIFACT_NAME="deps-linux-${TARGET}-${CONFIG}-${{ needs.pre-checks.outputs.shortHash }}"
          FILE_NAME="linux-deps-$(date +%Y-%m-%d)-${TARGET}-${CONFIG}.tar.gz"

          echo "artifactName=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "artifactFileName=${FILE_NAME}" >> $GITHUB_OUTPUT
          echo "target=${TARGET}" >> $GITHUB_OUTPUT
          echo "config=${CONFIG}" >> $GITHUB_OUTPUT

      - name: Build Linux Dependencies
        run: |
          # Build Linux Dependencies

          export CONFIGURATION="${{ steps.setup.outputs.config }}"
          export TARGET="${{ steps.setup.outputs.target }}"
          
          chmod +x ./build-dependencies.sh
          ./build-dependencies.sh

      - name: Publish Build Artifacts
        if: github.event_name != 'pull_request' || fromJSON(needs.pre-checks.outputs.seekingTesters)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifactName }}
          path: ${{ github.workspace }}/${{ steps.setup.outputs.artifactFileName }}

  ffmpeg-linux-build:
    name: Build FFmpeg for Linux
    runs-on: ubuntu-22.04
    needs: pre-checks
    permissions:
      contents: read
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg Build Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            build-essential \
            cmake \
            nasm \
            yasm \
            pkg-config \
            git

      - name: Build FFmpeg and dependencies
        run: |
          # Build FFmpeg with all dependencies
          
          export TARGET="x86_64"
          export CONFIGURATION="Release"
          export SUB_DIR="deps.ffmpeg"
          
          chmod +x ./build-dependencies.sh
          ./build-dependencies.sh

      - name: Setup Environment
        id: setup
        run: |
          # Setup Environment

          TARGET="x86_64"
          ARTIFACT_NAME="ffmpeg-linux-${TARGET}-${{ needs.pre-checks.outputs.shortHash }}"
          FILE_NAME="linux-ffmpeg-$(date +%Y-%m-%d)-${TARGET}.tar.gz"

          echo "artifactName=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "artifactFileName=${FILE_NAME}" >> $GITHUB_OUTPUT
          echo "target=${TARGET}" >> $GITHUB_OUTPUT

      - name: Package FFmpeg
        run: |
          # Package FFmpeg
          
          cd linux/sesame-dependencies-x86_64-Release
          tar -czf "linux-ffmpeg-$(date +%Y-%m-%d)-x86_64.tar.gz" ./*
          mv "linux-ffmpeg-$(date +%Y-%m-%d)-x86_64.tar.gz" "${GITHUB_WORKSPACE}/"

      - name: Publish Build Artifacts
        if: github.event_name != 'pull_request' || fromJSON(needs.pre-checks.outputs.seekingTesters)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.artifactName }}
          path: ${{ github.workspace }}/${{ steps.setup.outputs.artifactFileName }}

  make-release:
    name: Create and upload release
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    needs: [ffmpeg-windows-build, windows-build, linux-build, ffmpeg-linux-build]
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Metadata
        id: metadata
        run: |
          : Get Metadata
          echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Download build artifacts
        uses: actions/download-artifact@v4

      - name: Download CEF Binaries
        run: |
          : Download CEF Binaries
          set -e  # Exit on error
          
          # Read CEF configuration
          CEF_WINDOWS_URL=$(jq -r '.cef_binaries.windows.url' cef-config.json)
          CEF_WINDOWS_FILENAME=$(jq -r '.cef_binaries.windows.filename' cef-config.json)
          CEF_LINUX_URL=$(jq -r '.cef_binaries.linux.url' cef-config.json)
          CEF_LINUX_FILENAME=$(jq -r '.cef_binaries.linux.filename' cef-config.json)
          
          # Validate configuration values
          if [[ -z "${CEF_WINDOWS_URL}" || "${CEF_WINDOWS_URL}" == "null" ]]; then
            echo "Error: CEF Windows URL not found in configuration"
            exit 1
          fi
          if [[ -z "${CEF_WINDOWS_FILENAME}" || "${CEF_WINDOWS_FILENAME}" == "null" ]]; then
            echo "Error: CEF Windows filename not found in configuration"
            exit 1
          fi
          if [[ -z "${CEF_LINUX_URL}" || "${CEF_LINUX_URL}" == "null" ]]; then
            echo "Error: CEF Linux URL not found in configuration"
            exit 1
          fi
          if [[ -z "${CEF_LINUX_FILENAME}" || "${CEF_LINUX_FILENAME}" == "null" ]]; then
            echo "Error: CEF Linux filename not found in configuration"
            exit 1
          fi
          
          echo "Downloading Windows CEF binary from: ${CEF_WINDOWS_URL}"
          curl -fL --retry 3 --retry-delay 5 -o "${GITHUB_WORKSPACE}/${CEF_WINDOWS_FILENAME}" "${CEF_WINDOWS_URL}"
          
          echo "Downloading Linux CEF binary from: ${CEF_LINUX_URL}"
          curl -fL --retry 3 --retry-delay 5 -o "${GITHUB_WORKSPACE}/${CEF_LINUX_FILENAME}" "${CEF_LINUX_URL}"
          
          echo "CEF binaries downloaded successfully"
          ls -lh "${GITHUB_WORKSPACE}"/cef_binary_*

      - name: Display structure of downloaded files
        run: ls -R ${{ github.workspace }}

      - name: Package Windows dependencies
        run: |
          : Package Windows dependencies
          shopt -s extglob
          shopt -s nullglob
          arch=x64

          # make array of configs containing Debug and Release and iterate over them
          for config in Debug Release; do
            _temp=$(mktemp -d)
            pushd "${_temp}" > /dev/null

            for artifact in ${GITHUB_WORKSPACE}/**/*.zip; do
              echo "Processing ${artifact}"
              if [[ ${artifact} == *ffmpeg* || ${artifact} == *${config}* ]]; then
                echo "Unzipping ${artifact}"
                case ${artifact} in
                  *.zip) unzip -o ${artifact} > /dev/null ;;
                  *.tar.xz) XZ_OPT=-T0 tar -xJf ${artifact} ;;
                  *.tar.gz) tar -xzf ${artifact} ;;
                esac
              fi
            done

            zip -r windows-${config}-deps-${{ steps.metadata.outputs.version }}-${arch}.zip -- *
            mv windows-${config}-deps-${{ steps.metadata.outputs.version }}-${arch}.zip ${GITHUB_WORKSPACE}

            popd > /dev/null
          done

      - name: Package Linux dependencies
        run: |
          : Package Linux dependencies
          shopt -s extglob
          shopt -s nullglob
          arch=x86_64
          
          # Package Debug and Release configurations
          for config in Debug Release; do
            _temp=$(mktemp -d)
            pushd "${_temp}" > /dev/null
            
            # Extract dependency archives for this configuration
            for artifact in ${GITHUB_WORKSPACE}/**/linux-deps-*-${config}.tar.gz; do
              if [[ -f "${artifact}" ]]; then
                echo "Extracting ${artifact}"
                tar -xzf "${artifact}"
              fi
            done
            
            # Extract FFmpeg archive (for both Debug and Release to match Windows)
            for artifact in ${GITHUB_WORKSPACE}/**/linux-ffmpeg-*.tar.gz; do
              if [[ -f "${artifact}" ]]; then
                echo "Extracting FFmpeg ${artifact}"
                tar -xzf "${artifact}"
              fi
            done
            
            # Create combined archive
            tar -czf linux-${config}-deps-${{ steps.metadata.outputs.version }}-${arch}.tar.gz *
            mv linux-${config}-deps-${{ steps.metadata.outputs.version }}-${arch}.tar.gz ${GITHUB_WORKSPACE}
            
            popd > /dev/null
          done

      - name: Generate Checksums
        run: |
          : Generate Checksums
          shopt -s extglob
          echo "### Checksums" > ${{ github.workspace }}/CHECKSUMS.txt
          for file in ${{ github.workspace }}/@(*.tar.xz|*.tar.gz|*.zip); do
            echo "    ${file##*/}: $(sha256sum "${file}" | cut -d " " -f 1)" >> ${{ github.workspace }}/CHECKSUMS.txt
          done

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564
        with:
          draft: false
          prerelease: false
          tag_name: ${{ steps.metadata.outputs.version }}
          name: Sesame Dependencies Build ${{ steps.metadata.outputs.version }}
          body_path: ${{ github.workspace }}/CHECKSUMS.txt
          files: |
            ${{ github.workspace }}/windows-*-x64*.zip
            ${{ github.workspace }}/linux-*.tar.gz
            ${{ github.workspace }}/cef_binary_*
